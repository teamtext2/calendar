<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Text2 — Calendar</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root {
      --primary: #2563eb; /* Professional blue */
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --white: #ffffff;
      --black: #000000;
      --bg: #ffffff;
      --bg-secondary: #f8fafc;
      --text: #1f2937;
      --text-dark: #111827;
      --text-muted: #6b7280;
      --text-light: #9ca3af;
      --border: #e5e7eb;
      --border-light: #f3f4f6;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --transition: all 0.2s ease-in-out;
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    /* --- BACKGROUND --- */
    body {
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
      overflow: hidden;
      position: relative;
    }
    
    /* Subtle pattern background */
    body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
          radial-gradient(circle at 25% 25%, rgba(37, 99, 235, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
        z-index: -1;
    }


    /* --- MAIN APP CONTAINER --- */
    .calendar-app {
      width: 100%;
      max-width: 1200px;
      height: calc(100vh - 32px);
      max-height: 800px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- HEADER --- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .nav-buttons, .date-selector {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-btn, .date-selector button {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .icon-btn {
      width: 40px;
      height: 40px;
    }
    
    .icon-btn svg {
      width: 20px;
      height: 20px;
    }

    .icon-btn:hover, .date-selector button:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--white);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .date-selector button {
      padding: 8px 16px;
      font-weight: 500;
      font-size: 16px;
    }

    #calendarDisplay {
      text-align: center;
      font-weight: 600;
      font-size: 20px;
      color: var(--text-dark);
      flex-grow: 1;
    }

    /* --- CALENDAR --- */
    .calendar-container {
      padding: 24px;
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 12px;
      flex: 1;
      min-height: 0;
    }

    .day-cell {
      background: var(--white);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      color: var(--text);
    }

    .day-cell:hover {
      transform: scale(1.02);
      border-color: var(--primary);
      background: var(--bg-secondary);
      box-shadow: var(--shadow);
    }
    
    .day-cell.inactive {
        color: var(--text-light);
        background: var(--bg-secondary);
        pointer-events: none;
        opacity: 0.5;
    }

    .day-number {
      font-size: 16px;
      font-weight: 500;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .day-cell:hover .day-number {
        color: var(--primary);
        font-weight: 600;
    }

    .day-cell .current-day {
      background-color: var(--primary);
      color: var(--white);
      font-weight: 700;
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    .event-dot {
      position: absolute;
      bottom: 8px;
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(37, 99, 235, 0.3);
    }
    
    /* --- ADD BUTTON --- */
    .add-btn {
      position: absolute;
      bottom: 40px;
      right: 40px;
      background: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
      z-index: 50;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .add-btn:hover {
      transform: scale(1.05) rotate(90deg);
      background: var(--primary-dark);
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
    }

    /* --- MODALS --- */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal.show {
        display: flex;
        opacity: 1;
    }

    .modal-content {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 24px;
      width: min(450px, 90vw);
      max-height: 80vh;
      overflow-y: auto;
      color: var(--text);
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    
    .modal.show .modal-content {
        transform: scale(1);
    }

    .modal-content h3 {
      color: var(--text-dark);
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
      text-align: center;
    }

    input, textarea {
      width: 100%;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      font-size: 16px;
      margin-bottom: 12px;
      transition: var(--transition);
      color: var(--text);
    }
    
    input::placeholder, textarea::placeholder {
        color: var(--text-muted);
    }

    input:focus, textarea:focus {
      background: var(--white);
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      border: none;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
      box-shadow: var(--shadow);
    }
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text);
        border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background: var(--border-light);
      border-color: var(--text-muted);
    }
    
    .btn-danger {
        background: #dc2626;
        color: var(--white);
    }
    .btn-danger:hover {
        background: #b91c1c;
        transform: translateY(-1px);
    }
    
    #selectorList {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
    }
    
    #selectorList button {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
    }
    #selectorList button:hover {
        background: var(--primary);
        color: var(--white);
        border-color: var(--primary);
    }
    
    #eventDetailsContent b {
        color: var(--primary);
        display: block;
        font-size: 1.1em;
    }
    #eventDetailsContent p {
        margin: 4px 0 12px;
        line-height: 1.6;
    }
    #eventDetailsContent hr {
        border: none;
        height: 1px;
        background-color: var(--border);
        margin-bottom: 12px;
    }


    /* --- RESPONSIVE --- */
    /* Desktop Large (1200px+) */
    @media (min-width: 1200px) {
      .calendar-app {
        max-width: 1400px;
        height: calc(100vh - 40px);
      }
      .calendar-container {
        padding: 32px;
      }
      .days-grid {
        gap: 16px;
      }
      .day-cell {
        min-height: 85px;
      }
      .day-number {
        font-size: 18px;
        width: 36px;
        height: 36px;
      }
      .weekdays {
        font-size: 15px;
        margin-bottom: 16px;
      }
    }

    /* Desktop Medium (992px - 1199px) */
    @media (max-width: 1199px) and (min-width: 992px) {
      .calendar-app {
        max-width: 1000px;
        height: calc(100vh - 32px);
      }
      .calendar-container {
        padding: 24px;
      }
      .days-grid {
        gap: 12px;
      }
      .day-cell {
        min-height: 75px;
      }
      .day-number {
        font-size: 16px;
        width: 32px;
        height: 32px;
      }
    }

    /* Tablet Landscape (768px - 991px) */
    @media (max-width: 991px) and (min-width: 768px) {
      .calendar-app {
        max-width: 900px;
        height: calc(100vh - 20px);
      }
      .header {
        padding: 16px 20px;
      }
      .calendar-container {
        padding: 20px;
      }
      .days-grid {
        gap: 10px;
      }
      .day-cell {
        min-height: 65px;
      }
      .day-number {
        font-size: 15px;
        width: 30px;
        height: 30px;
      }
      #calendarDisplay {
        font-size: 18px;
      }
      .weekdays {
        font-size: 13px;
        margin-bottom: 10px;
      }
      .add-btn {
        width: 56px;
        height: 56px;
        bottom: 30px;
        right: 30px;
      }
    }

    /* Tablet Portrait & Mobile Large (481px - 767px) */
    @media (max-width: 767px) and (min-width: 481px) {
      body { 
        padding: 8px; 
      }
      .calendar-app { 
        height: calc(100vh - 16px); 
        max-height: none;
        border-radius: var(--radius-md); 
      }
      .header { 
        flex-direction: column;
        gap: 12px; 
        padding: 16px; 
        text-align: center;
      }
      .nav-buttons {
        order: 2;
        justify-content: center;
      }
      #calendarDisplay { 
        order: 1; 
        font-size: 20px; 
        margin-bottom: 0;
      }
      .date-selector {
        order: 3;
        justify-content: center;
      }
      .calendar-container { 
        padding: 16px; 
      }
      .days-grid { 
        gap: 8px; 
      }
      .day-cell {
        min-height: 55px;
      }
      .day-number {
        font-size: 14px;
        width: 28px;
        height: 28px;
      }
      .weekdays {
        font-size: 13px;
        margin-bottom: 10px;
      }
      .add-btn { 
        width: 50px; 
        height: 50px; 
        bottom: 24px; 
        right: 24px; 
      }
      .modal-content {
        width: min(400px, 95vw);
        padding: 20px;
      }
    }

    /* Mobile Portrait (320px - 480px) */
    @media (max-width: 480px) {
      body { 
        padding: 0; 
      }
      .calendar-app { 
        height: 100vh; 
        max-height: none;
        border-radius: 0; 
      }
      .header { 
        flex-direction: column;
        gap: 10px; 
        padding: 12px 16px; 
        text-align: center;
      }
      .nav-buttons {
        order: 2;
        justify-content: center;
      }
      #calendarDisplay { 
        order: 1; 
        font-size: 18px; 
        margin-bottom: 0;
      }
      .date-selector {
        order: 3;
        justify-content: center;
      }
      .date-selector button {
        padding: 6px 12px;
        font-size: 14px;
      }
      .icon-btn {
        width: 36px;
        height: 36px;
      }
      .icon-btn svg {
        width: 18px;
        height: 18px;
      }
      .calendar-container { 
        padding: 12px; 
      }
      .weekdays {
        font-size: 12px;
        margin-bottom: 8px;
      }
      .days-grid { 
        gap: 6px; 
      }
      .day-cell {
        min-height: 48px;
      }
      .day-number {
        font-size: 13px;
        width: 26px;
        height: 26px;
      }
      .event-dot {
        width: 5px;
        height: 5px;
        bottom: 6px;
      }
      .add-btn { 
        width: 48px; 
        height: 48px; 
        bottom: 16px; 
        right: 16px; 
      }
      .add-btn svg {
        width: 24px;
        height: 24px;
      }
      .modal {
        padding: 10px;
      }
      .modal-content {
        width: min(350px, 98vw);
        padding: 16px;
        border-radius: var(--radius-md);
      }
      .modal-content h3 {
        font-size: 18px;
        margin-bottom: 16px;
      }
      input, textarea {
        padding: 10px 12px;
        font-size: 15px;
        margin-bottom: 10px;
      }
      .modal-btn {
        padding: 10px;
        font-size: 14px;
      }
    }

    /* Extra Small Mobile (max 319px) */
    @media (max-width: 319px) {
      .header {
        padding: 10px 12px;
      }
      #calendarDisplay {
        font-size: 16px;
      }
      .calendar-container {
        padding: 8px;
      }
      .days-grid {
        gap: 4px;
      }
      .day-cell {
        min-height: 42px;
      }
      .day-number {
        font-size: 12px;
        width: 24px;
        height: 24px;
      }
      .weekdays {
        font-size: 11px;
      }
      .add-btn {
        width: 44px;
        height: 44px;
        bottom: 12px;
        right: 12px;
      }
      .modal-content {
        width: min(300px, 96vw);
        padding: 12px;
      }
    }

    /* Landscape orientation adjustments */
    @media (max-height: 500px) and (orientation: landscape) {
      .calendar-app {
        height: calc(100vh - 10px);
      }
      .header {
        padding: 8px 16px;
      }
      .calendar-container {
        padding: 8px 16px;
      }
      .days-grid {
        gap: 4px;
      }
      .day-cell {
        min-height: 35px;
      }
      .day-number {
        font-size: 12px;
        width: 22px;
        height: 22px;
      }
      .weekdays {
        font-size: 11px;
        margin-bottom: 6px;
      }
      .add-btn {
        width: 40px;
        height: 40px;
        bottom: 10px;
        right: 10px;
      }
    }

    /* High DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .event-dot {
        box-shadow: 0 0 6px var(--primary-light);
      }
      .day-cell.current-day .day-number {
        box-shadow: 0 0 12px rgba(138, 92, 246, 0.4);
      }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .day-cell:hover {
        transform: none;
        border-color: var(--border);
        background: var(--white);
        box-shadow: none;
      }
      .day-cell:active {
        transform: scale(0.95);
        background: var(--bg-secondary);
        border-color: var(--primary);
      }
      .day-cell:hover .day-number {
        color: var(--text);
        font-weight: 500;
      }
      .icon-btn:hover, .date-selector button:hover {
        transform: none;
        background: var(--white);
        border-color: var(--border);
        color: var(--text);
        box-shadow: none;
      }
      .icon-btn:active, .date-selector button:active {
        transform: scale(0.95);
        background: var(--primary);
        border-color: var(--primary);
        color: var(--white);
      }
      .add-btn:hover {
        transform: none;
        background: var(--primary);
        box-shadow: var(--shadow-lg);
      }
      .add-btn:active {
        transform: scale(0.95);
        background: var(--primary-dark);
      }
      .modal-btn:hover {
        transform: none;
      }
      .modal-btn:active {
        transform: scale(0.98);
      }
      
      /* Increase touch targets for better accessibility */
      .day-cell {
        min-height: 44px;
      }
      .icon-btn {
        min-width: 44px;
        min-height: 44px;
      }
      .date-selector button {
        min-height: 44px;
        padding: 8px 16px;
      }
      .add-btn {
        min-width: 48px;
        min-height: 48px;
      }
    }

    /* Accessibility improvements for larger text */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --bg-secondary: #1e293b;
        --text: #f1f5f9;
        --text-dark: #f8fafc;
        --text-muted: #64748b;
        --text-light: #94a3b8;
        --border: #334155;
        --border-light: #475569;
        --white: #1e293b;
        --black: #f8fafc;
      }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      :root {
        --primary: #0000ff;
        --text: #000000;
        --text-dark: #000000;
        --border: #000000;
        --shadow: 0 0 0 2px #000000;
      }
      .day-cell {
        border: 2px solid var(--border);
      }
      .day-cell:hover {
        border: 2px solid var(--primary);
      }
    }

    /* Focus indicators for keyboard navigation */
    .icon-btn:focus,
    .date-selector button:focus,
    .add-btn:focus,
    .modal-btn:focus,
    .day-cell:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Skip to content link for screen readers */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: var(--primary);
      color: var(--white);
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1000;
    }
    .skip-link:focus {
      top: 6px;
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Bỏ qua đến nội dung chính</a>

  <div class="calendar-app" id="main-content">
    <div class="header">
      <div class="nav-buttons">
        <button id="prevMonthBtn" class="icon-btn" aria-label="Tháng trước">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
        <button id="nextMonthBtn" class="icon-btn" aria-label="Tháng sau">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
      </div>
      <div id="calendarDisplay"></div>
      <div class="date-selector">
        <button id="monthSelector">Tháng</button>
        <button id="yearSelector">Năm</button>
      </div>
    </div>

    <div class="calendar-container">
      <div class="weekdays">
        <span>CN</span><span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span>
      </div>
      <div id="daysGrid" class="days-grid"></div>
    </div>
  </div>

  <button id="addEventBtn" class="add-btn" aria-label="Thêm sự kiện">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
  </button>

  <!-- Modals -->
  <div id="selectorModal" class="modal">
    <div class="modal-content">
      <h3 id="selectorTitle">Chọn...</h3>
      <div id="selectorList"></div>
      <div class="modal-actions">
          <button onclick="closeModal('selectorModal')" class="modal-btn btn-secondary">Đóng</button>
      </div>
    </div>
  </div>

  <div id="eventFormModal" class="modal">
    <div class="modal-content">
      <h3>Thêm sự kiện cho <span id="eventDateDisplay"></span></h3>
      <form id="eventForm">
        <input type="hidden" id="eventDayDate">
        <input type="text" id="eventTitle" placeholder="Tên sự kiện" required>
        <textarea id="eventDetails" placeholder="Chi tiết (tùy chọn)" rows="3"></textarea>
        <div class="modal-actions">
            <button type="button" onclick="closeModal('eventFormModal')" class="modal-btn btn-secondary">Hủy</button>
            <button type="submit" class="modal-btn btn-primary">Lưu</button>
        </div>
      </form>
    </div>
  </div>

  <div id="eventDetailsModal" class="modal">
    <div class="modal-content">
      <h3>Sự kiện ngày <span id="popupEventDate"></span></h3>
      <div id="eventDetailsContent"></div>
      <div class="modal-actions">
        <button onclick="closeModal('eventDetailsModal')" class="modal-btn btn-secondary">Đóng</button>
        <button onclick="deleteEvent()" class="modal-btn btn-danger">Xóa</button>
      </div>
    </div>
  </div>

  <script>
    const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];
    const calendarDisplay = document.getElementById("calendarDisplay");
    const daysGrid = document.getElementById("daysGrid");
    const monthSelectorBtn = document.getElementById("monthSelector");
    const yearSelectorBtn = document.getElementById("yearSelector");
    
    const selectorModal = document.getElementById("selectorModal");
    const selectorTitle = document.getElementById("selectorTitle");
    const selectorList = document.getElementById("selectorList");
    
    const eventFormModal = document.getElementById("eventFormModal");
    const eventDetailsModal = document.getElementById("eventDetailsModal");
    
    const popupEventDate = document.getElementById("popupEventDate");
    const eventDetailsContent = document.getElementById("eventDetailsContent");
    const eventForm = document.getElementById("eventForm");
    const eventDateDisplay = document.getElementById("eventDateDisplay");
    const eventDayDateInput = document.getElementById("eventDayDate");

    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let selectedDayForEvent = null;

    function loadEvents() {
      return JSON.parse(localStorage.getItem("calendarEvents") || "{}");
    }

    function saveEvents(e) {
      localStorage.setItem("calendarEvents", JSON.stringify(e));
    }

    function formatDate(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
    }

    function formatDisplayDate(d) {
      const p = d.split("-");
      return `${p[2]}/${p[1]}/${p[0]}`;
    }

    function renderCalendar() {
      const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
      const firstDay = firstDayOfMonth.getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      daysGrid.innerHTML = "";
      calendarDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      monthSelectorBtn.textContent = monthNames[currentMonth];
      yearSelectorBtn.textContent = currentYear;

      const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

      // Previous month's days
      for (let i = firstDay; i > 0; i--) {
        const day = daysInPrevMonth - i + 1;
        daysGrid.appendChild(createCell(day, "inactive"));
      }

      const today = new Date();
      const events = loadEvents();
      // Current month's days
      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(currentYear, currentMonth, d);
        const key = formatDate(date);
        const cell = createCell(d, "");

        if (today.toDateString() === date.toDateString()) {
          const span = cell.querySelector(".day-number");
          span.classList.add("current-day");
        }
        
        if (events[key]?.length) {
          const dot = document.createElement("div");
          dot.className = "event-dot";
          cell.appendChild(dot);
          cell.onclick = (e) => { e.stopPropagation(); showEventDetails(key); };
        } else {
          cell.onclick = (e) => { e.stopPropagation(); showEventForm(key); };
        }
        daysGrid.appendChild(cell);
      }
      
      // Next month's days
      const totalCells = 42; // 6 rows * 7 columns
      const filledCells = firstDay + daysInMonth;
      for (let i = 1; i <= totalCells - filledCells; i++) {
        daysGrid.appendChild(createCell(i, "inactive"));
      }
    }

    function createCell(day, className) {
      const div = document.createElement("div");
      div.className = `day-cell ${className}`;
      const num = document.createElement("span");
      num.className = "day-number";
      num.textContent = day;
      div.appendChild(num);
      return div;
    }

    function changeMonth(x) {
      currentMonth += x;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    }
    
    function showModal(id) {
        document.getElementById(id).classList.add('show');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }

    function showSelector(type) {
      selectorList.innerHTML = "";
      selectorTitle.textContent = type === "month" ? "Chọn tháng" : "Chọn năm";
      const opts = type === "month" 
        ? monthNames.map((n, i) => ({ n, i })) 
        : [...Array(11)].map((_, i) => ({ n: currentYear - 5 + i, i: currentYear - 5 + i }));

      opts.forEach(o => {
        const b = document.createElement("button");
        b.textContent = o.n;
        b.onclick = () => {
          if (type === "month") currentMonth = o.i;
          else currentYear = o.i;
          renderCalendar();
          closeModal("selectorModal");
        };
        selectorList.appendChild(b);
      });
      showModal("selectorModal");
    }

    function showEventForm(date) {
      selectedDayForEvent = date;
      eventDateDisplay.textContent = formatDisplayDate(date);
      eventDayDateInput.value = date;
      eventForm.reset();
      showModal("eventFormModal");
      document.getElementById("eventTitle").focus();
    }

    eventForm.onsubmit = e => {
      e.preventDefault();
      const title = document.getElementById("eventTitle").value;
      const details = document.getElementById("eventDetails").value;
      const date = eventDayDateInput.value;
      if (!title) return;
      const ev = loadEvents();
      if (!ev[date]) ev[date] = [];
      ev[date].push({ title, details });
      saveEvents(ev);
      renderCalendar();
      closeModal("eventFormModal");
    };

    function showEventDetails(date) {
      selectedDayForEvent = date;
      const ev = loadEvents()[date] || [];
      popupEventDate.textContent = formatDisplayDate(date);
      eventDetailsContent.innerHTML = ev.length ? ev.map(e => `<div><b>${e.title}</b><p>${e.details || "Không có chi tiết"}</p></div><hr>`).join("") : "<p>Không có sự kiện</p>";
      showModal("eventDetailsModal");
    }

    function deleteEvent() {
      if (!selectedDayForEvent) return;
      const ev = loadEvents();
      delete ev[selectedDayForEvent];
      saveEvents(ev);
      renderCalendar();
      closeModal("eventDetailsModal");
    }
    
    // --- Event Listeners ---
    document.getElementById("prevMonthBtn").onclick = () => changeMonth(-1);
    document.getElementById("nextMonthBtn").onclick = () => changeMonth(1);
    monthSelectorBtn.onclick = () => showSelector("month");
    yearSelectorBtn.onclick = () => showSelector("year");
    document.getElementById("addEventBtn").onclick = () => showEventForm(formatDate(new Date()));
    
    // Close modal on outside click
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target.id);
        }
    });

    renderCalendar();
  </script>
</body>
</html>
